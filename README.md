# VK-Education-Highload –ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞
–®–∏—à–∫–∏–Ω –ê. –Æ. WEB-41/31
# RUTUBE
## 1. –¢–µ–º–∞ –∏ –¶–µ–ª–µ–≤–∞—è –ê—É–¥–∏—Ç–æ—Ä–∏—è
**–¢–∏–ø —Å–µ—Ä–≤–∏—Å–∞**: –í–∏–¥–µ–æ—Ö–æ—Å—Ç–∏–Ω–≥
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏**: –†–æ—Å—Å–∏—è –∏ –°–ù–ì

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
|–°—Ç—Ä–∞–Ω–∞|% –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π|
|-|--------|
|–†–æ—Å—Å–∏—è|93.3%|
|–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω|1.3%|
|–ë–µ–ª–∞—Ä—É—Å—å|1%|
|–£–∫—Ä–∞–∏–Ω–∞|0.9%|
[–ò—Å—Ç–æ—á–Ω–∏–∫][3]

__–ö–ª—é—á–µ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª__: –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤–∏–¥–µ–æ

__–ö–ª—é—á–µ–≤–æ–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ__: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ

### MVP
* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
* –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
* –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ (–ø–ª–µ–µ—Ä)
* –ü—Ä–æ—Å–º–æ—Ç—Ä—ã –∏ –ª–∞–π–∫–∏
* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
* –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π 
* –ü–æ–∏—Å–∫
* –ì–ª–∞–≤–Ω–∞—è –°—Ç—Ä–∞–Ω–∏—Ü–∞
* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∞

## 2. –†–∞—Å—á—ë—Ç –Ω–∞–≥—Ä—É–∑–∫–∏

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
[**MAU**: 80M][1]

[**DAU**: 20M][1]

[4M –∫–∞–Ω–∞–ª–æ–≤ (–∑–∞—Ä–µ–≥–µ—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) –≤—Å–µ–≥–æ][10]

**–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–∑–∏—Ç–∞: [46 –º–∏–Ω—É—Ç][10]**

[**–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –≤–∏–¥–µ–æ**: 12 –º–∏–Ω—É—Ç][8]

3.8 –í–∏–¥–µ–æ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ

[**–í—Å–µ–≥–æ –≤–∏–¥–µ–æ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ - 388–ú**][7]

1 –º–∏–Ω—É—Ç–∞ –≤–∏–¥–µ–æ –≤–µ—Å–∏—Ç 480–º–±–∏—Ç (0.48–≥–±)(1080p, 30fps, 8–ú–±–∏—Ç/—Å –±–∏—Ç—Ä–µ–π—Ç–∞).

–û–±—â–∏–π –≤–µ—Å –≤–∏–¥–µ–æ –Ω–∞ —Ä—É—Ç—É–±–µ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç: 388–ú * 12 * 0.48 = **2‚Äâ234 –ü–ë**

[421–ú –í–∏–¥–µ–æ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ –≤—Å–µ–≥–æ][5]

[33000–ú –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∑–∞ –ø–æ–ª–≥–æ–¥–∞][5]

33000M / (6 * 30) = **183–ú / –¥–µ–Ω—å** –∏–ª–∏ **2–ö / —Å–µ–∫—É–Ω–¥–∞**


### RPS
| –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞                                  |    –°—É—Ç–æ—á–Ω–æ  | –°—Ä–µ–¥–Ω–µ–µ RPS | –ü–∏–∫–æ–≤–æ–µ RPS (–°—Ä–µ–¥–Ω–µ–µ * 3) | –ü–æ—è—Å–Ω–µ–Ω–∏–µ  |
| :------------------------------------------: | :-----------: | ----------: |        ----------:        | :----------:|
| **–ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ**                           |          183M |         ~2K |          ~6K              |            |
| **–°—Ç—Ä–∏–º–∏–Ω–≥ –≤–∏–¥–µ–æ**                           |       131760M |       ~1.4M |          ~4.2M            | 2–ö –∑–∞–ø—É—Å–∫–æ–≤ –≤–∏–¥–µ–æ –≤ —Å–µ–∫—É–Ω–¥—É * 12*60 –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –ø–æ–ª—É—á–∞–µ—Ç—Å—è –±–æ–ª—å–Ω–æ –º–Ω–æ–≥–æ, –Ω–æ –ø–æ —Ü–∏—Ñ—Ä–∞–º –≤—Å—ë —Ç–∞–∫ –±—É–¥—Ç–æ |
| **–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ**                           |          370–ö |        ~4.3 |          ~13              | ~+135M –≤–∏–¥–µ–æ –∑–∞ –≥–æ–¥ => 135–ú/365 = 370K  |
| **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**                              |            4M |         ~47 |         ~141              | [4M –∫–∞–Ω–∞–ª–æ–≤ –≤—Å–µ–≥–æ][10] |
| **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**                              |            1M |         ~12 |          ~36              | 1 –∫–æ–º–º–µ–Ω—Ç –Ω–∞ 200 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ |
| **–ì–ª–∞–≤–Ω–∞—è –°—Ç—Ä–∞–Ω–∏—Ü–∞**                         |           20M |        ~231 |         ~696              | –ö–∞–∂–¥—ã–π –∏–∑ DAU –≤–∏–¥–∏—Ç –≥–ª–∞–≤–Ω—É—é, —Ö–æ—Ç—è –∫—Ç–æ-—Ç–æ –∂–µ –∑–∞—Ö–æ–¥–∏—Ç —Ç–æ—á–µ—á–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ –≤–∏–¥–µ–æ... |
| **–ü—Ä–æ—Ñ–∏–ª—å**                                  |           20K |        ~0.2 |         ~0.6              | –í –¥–∞–ª—å–Ω–µ–π—à–µ–º —Ç–∞–∫–∏–µ –∫–æ–ø–µ–π–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º... |
| **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**                             |          200M |       ~2.3K |          ~7K              | –ö–∞–∂–¥—ã–π —Ä–∞–∑ –∫–æ–≥–¥–∞ —Å–º–æ—Ç—Ä—è—Ç –≤–∏–¥–µ–æ –ø–æ–ª—É—á–∞—é—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ + –∫–æ–ø–µ–π–∫–∏ —Å –≥–ª–∞–≤–Ω–æ–π |
| **–õ–∞–π–∫–∏**                                    |            8M |         ~94 |         ~282              | 4 –ª–∞–π–∫–∞ –Ω–∞ 100 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ |
| **–ú–µ–¥–∏–∞ (–∞–≤–∞—Ç–∞—Ä–∫–∏ + –ø—Ä–µ–≤—å—é—à–∫–∏)**             |        2 745M |        ~32K |         ~96K              | –ù–∞ 1–º —ç–∫—Ä–∞–Ω–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ —É–º–µ—â–∞–µ—Ç—Å—è 8 —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ, –æ–∫—Ä—É–≥–ª–∏–º –¥–æ 10 –∏ –¥–æ–±–∞–≤–∏–º 5 –∞–≤–∞—Ç–∞—Ä–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  |

### –¢—Ä–∞—Ñ–∏–∫
| –¢–∏–ø —Ç—Ä–∞—Ñ–∏–∫–∞                                                           | –°—Ä–µ–¥–Ω–µ–µ (–ì–±/—Å) | –ü–∏–∫–æ–≤–æ–µ (–ì–±/c) | –í —Å—É—Ç–∫–∏ (–¢–ë) | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                      |
| --------------------------------------------------------------------- | -------------: | -------------: | ------------: | :------------------------------: |
| **–ü—Ä–æ—Å–º–æ—Ç—Ä –í–∏–¥–µ–æ**                                                    |            ~10 |            ~30 |      864     | 2000 –≤–∏–¥–µ–æ/c * 0.005 –º–±          |
| **–°—Ç—Ä–∏–º–∏–Ω–≥ –í–∏–¥–µ–æ**                                                    |        ~10‚Äâ400 |        ~31 200 |  624‚Äâ000     | 1.4M RPS * 8–º–±–∏—Ç/c // —á—ë—Ç –º–Ω–æ–≥–æ              |
| **–ó–∞–≥—Ä—É–∑–∫–∞ –í–∏–¥–µ–æ**                                                    |            ~25 |            ~75 |    6‚Äâ480     | 4.3 * 12 –º–∏–Ω * 0.48 –≥–±/–º–∏–Ω       |
| **–ú–µ–¥–∏–∞**                                                             |            ~64 |           ~192 |   16‚Äâ588     | 32K RPS * 2–º–±                    |
| **–ò—Ç–æ–≥–æ**                                                             |      **~1507** |      **~4521** | **380 000**  |                                  |
 
### –•—Ä–∞–Ω–∏–ª–∏—â–µ
|–•—Ä–∞–Ω–∏–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç| –ù–∞–¥–æ —Å–µ–π—á–∞—Å (–¢–ë) | –ù–∞–¥–æ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ –≥–æ–¥ (–¢–ë) |–ü–æ—è—Å–Ω–µ–Ω–∏–µ          |
|:--------------:|-----------------:|--------------------------:|:-----------------:|
|–í–∏–¥–µ–æ           |        2‚Äâ234 000 |                 3 041 280 | –ß—ë —Ç–∞–∫ –º–Ω–æ–≥–æ —Ç–æ...|
|–ú–µ–¥–∏–∞           |              850 |                      1190 |  4M * 2–ú–± (–∞–≤–∞—Ç–∞—Ä–∫–∏) + 421–ú * 2–ú–± (–ø—Ä–µ–≤—å—é—Ö–∏) |
|–¢–∞–±–ª–∏—á–∫–∏ (–ü—Ä–æ—Å–º–æ—Ç—Ä—ã, –ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç—ã)| | | –°—É—â–∏–µ –∫–æ–ø–µ–π–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –∫–æ—Ç–æ—Ä—ã–µ —è –¥–∞–∂–µ –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é –∫–∞–∫ —Å—á–∏—Ç–∞—Ç—å|

## 3. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ –¥–æ–º–µ–Ω–∞–º
| –î–æ–º–µ–Ω                                     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                         |
| ----------------------------------------- | -------------------------------------------------- |
| **auth.rutube.ru**                        | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏                  |
| **upload.rutube.ru**                      | –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞                         |
| **video.rutube.ru**                       | –û—Ç–¥–∞—á–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ (–ø–ª–µ–µ—Ä)                         |
| **api.rutube.ru**                         | –ü—Ä–æ—Å–º–æ—Ç—Ä—ã, –ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø–æ–∏—Å–∫, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ |
| **admin.rutube.ru**                       | –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—è                           |
| **media.rutube.ru**                       | –ü—Ä–µ–≤—å—é—Ö–∏ –∏ –∞–≤–∞—Ç–∞—Ä–∫–∏                                |

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–æ–≤

–ú–æ—Å–∫–≤–∞ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–Ω—Ç—Ä, –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –≤ –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–π —á–∞—Å—Ç–∏ –†–§.

–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ / –•–∞–±–∞—Ä–æ–≤—Å–∫ ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫ –¥–ª—è –î–∞–ª—å–Ω–µ–≥–æ –í–æ—Å—Ç–æ–∫–∞.
### –†–∞—Å—á–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### DNS


DNS-—Å–µ—Ä–≤–µ—Ä –Ω–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã


### Anycast

–û–±—ä—è–≤–ª—è–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ ip –≤ –î–¶ –ú–æ—Å–∫–≤—ã –∏ –î–∞–ª—å–Ω–µ–≥–æ –≤–æ—Å—Ç–æ–∫–∞, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –Ω–∞—à–µ–º—É —Å–µ—Ä–≤–∏—Å—É –æ–Ω –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ ip, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –¥–µ–ª–æ –∑–∞ BGP –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç –±–ª–∏–∂–∞–π—à–∏–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –î–¶

# 4. –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ (Rutube, 1 –î–¶)

## –ò—Å—Ö–æ–¥–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|-----------|-----------|
| –ü–∏–∫–æ–≤—ã–π —Ç—Ä–∞—Ñ–∏–∫ (–≤–∏–¥–µ–æ) | **31 200 Gbit/s** |
| –ü–∏–∫–æ–≤—ã–π —Ç—Ä–∞—Ñ–∏–∫ (API / —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ø—Ä–æ—á–µ–µ) | **300 Gbit/s** |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | **L4 (–≤–∏–¥–µ–æ)** + **L7 (API, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, TLS)** |
| –ü–æ–ª–∏—Ç–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è | **N + 1** |
| –†–∞–∑–º–µ—â–µ–Ω–∏–µ | **–≤—Å–µ –Ω–æ–¥—ã –≤ –æ–¥–Ω–æ–º –î–¶** |

---

## –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á—ë—Ç–∞

1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–¥ –ø–æ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:  
   **LB_bw = Peak_Gbps / Throughput_per_node (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö)**

2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è (N + 1):  
   **LB_final = LB_bw + 1**

---

## –†–∞—Å—á—ë—Ç –¥–ª—è L4 (–≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫)

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –ó–Ω–∞—á–µ–Ω–∏–µ |
|-------------|-----------|
| Peak_Gbps_L4 | **31 200 Gbit/s** |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–π L4-–Ω–æ–¥—ã | **400 Gbit/s** |

LB_bw_L4 = 31 200 / 400 = 78  
LB_final_L4 = 78 + 1 = **79 –Ω–æ–¥**

**–ò—Ç–æ–≥–æ (L4, –µ–¥–∏–Ω—ã–π –î–¶): 79 –Ω–æ–¥ (–≤—Å–µ –≤ –æ–¥–Ω–æ–º –î–¶).**

---

## –†–∞—Å—á—ë—Ç –¥–ª—è L7 (API / —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ / TLS)

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –ó–Ω–∞—á–µ–Ω–∏–µ |
|-------------|-----------|
| Peak_Gbps_L7 | **300 Gbit/s** |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–π L7-–Ω–æ–¥—ã | **40 Gbit/s** |

LB_bw_L7 = 300 / 40 = 7.5 ‚Üí 8 –Ω–æ–¥  
LB_final_L7 = 8 + 1 = **9 –Ω–æ–¥**

**–ò—Ç–æ–≥–æ (L7, –µ–¥–∏–Ω—ã–π –î–¶): 9 –Ω–æ–¥ (–≤—Å–µ –≤ –æ–¥–Ω–æ–º –î–¶).**

---

## –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ (–≤ –æ–¥–Ω–æ–º –î–¶)

| –°–ª–æ–π | –ü–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ | –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–æ–¥—ã | –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ | –í—Å–µ–≥–æ –Ω–æ–¥ |
|------|------------------|-----------------------------|----------------|----------:|
| **L4 (–≤–∏–¥–µ–æ)** | 31 200 Gbit/s | 400 Gbit/s | N+1 | **79** |
| **L7 (API, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)** | 300 Gbit/s | 40 Gbit/s | N+1 | **9** |

---

# 5. –õ–æ–≥–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞ –ë–î

``` mermaid
erDiagram
    users {
        int id PK
        varchar username
        varchar email
        varchar password_hash
        timestamp created_at
        varchar avatar_url
    }

    videos {
        int id PK
        int user_id FK
        varchar title
        text description
        varchar file_path
        varchar thumbnail_url
        date upload_date
        int duration
        bool is_moderated
    }

    views {
        int id PK
        int video_id FK
        int user_id FK
        timestamp view_date
    }

    likes {
        int id PK
        int video_id FK
        int user_id FK
        timestamp created_at
    }

    comments {
        int id PK
        int video_id FK
        int user_id FK
        int parent_comment_id FK "nullable"
        text text
        bool is_banned
        timestamp created_at
    }

    moderators {
        int id PK
        int user_id FK
        varchar role
    }

    sessions {
        varchar session_id PK
        int user_id FK
        timestamp created_at
        timestamp expires_at
        text session_data
    }

    video_storage {
        int id PK
        int video_id FK
        varchar storage_path
        varchar resolution
        varchar format
        int size_mb
        varchar checksum
        timestamp uploaded_at
    }

    video_stats {
        int id PK
        int video_id FK
        bigint total_views
        bigint total_likes
        timestamp updated_at
    }

    search_index {
        int id PK
        int video_id FK
        text keywords
        text tags
        tsvector search_vector
        timestamp updated_at
    }

    subscriptions {
        int id PK
        int subscriber_id FK
        int subscribed_to_id FK
        timestamp created_at
    }

    reports {
        int id PK
        int reporter_id FK
        int target_user_id FK "nullable"
        int target_video_id FK "nullable"
        int target_comment_id FK "nullable"
        text reason
        bool is_resolved
        timestamp created_at
    }

    users ||--o{ videos : "–∑–∞–≥—Ä—É–∂–∞–µ—Ç"
    users ||--o{ views : "–ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç"
    users ||--o{ likes : "—Å—Ç–∞–≤–∏—Ç –ª–∞–π–∫–∏"
    users ||--o{ comments : "–ø–∏—à–µ—Ç"
    users ||--o{ moderators : "–º–æ–∂–µ—Ç –±—ã—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º"
    users ||--o{ sessions : "–∏–º–µ–µ—Ç —Å–µ—Å—Å–∏–∏"
    users ||--o{ subscriptions : "–ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è"
    users ||--o{ reports : "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç"

    videos ||--o{ views : "–ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è"
    videos ||--o{ likes : "–ª–∞–π–∫–∞–µ—Ç—Å—è"
    videos ||--o{ comments : "–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è"
    videos ||--o{ video_storage : "–∏–º–µ–µ—Ç —Ñ–∞–π–ª—ã"
    videos ||--|| video_stats : "–∏–º–µ–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
    videos ||--|| search_index : "–∏–º–µ–µ—Ç –∏–Ω–¥–µ–∫—Å"
    videos ||--o{ reports : "–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º –∂–∞–ª–æ–±—ã"

    comments ||--o{ comments : "–æ—Ç–≤–µ—Ç –Ω–∞"
    comments ||--o{ reports : "–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º –∂–∞–ª–æ–±—ã"

    moderators ||--o{ reports : "–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç"

```

# 6 –§–∏–∑–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞ –ë–î
```mermaid
graph LR

subgraph PostgreSQL_Auth["Auth DB : PostgreSQL"]
    U[users]
    SUB[subscriptions]
    M[moderators]
end

subgraph PostgreSQL_Video["Video Metadata DB : PostgreSQL"]
    V[videos]
    VS[video_stats]
    VST[video_storage_metadata]
end

subgraph ClickHouse["Activity DB : ClickHouse"]
    VW[views]
    L[likes]
    C[comments]
    R[reports]
end

subgraph Redis["Redis : Sessions / Cache"]
    S[(sessions)]
end

subgraph MinIO["Object Storage : MinIO / S3"]
    OBJ[(video_files)]
end

subgraph Elasticsearch["Search Engine : Elasticsearch"]
    SI[(video_search_index)]
end

%% Relations
U --> V
U --> VW
U --> L
U --> C
U --> SUB
U --> R
V --> VW
V --> L
V --> C
V --> VS
V --> R
V --> VST
V --> SI
VST --> OBJ
C --> R
M --> R
S --> U

classDef shard fill:#ffcc00,stroke:#333,stroke-width:1px,color:#000
VW:::shard
L:::shard
C:::shard
VS:::shard


```

| –•—Ä–∞–Ω–∏–ª–∏—â–µ                   | –¢–∞–±–ª–∏—Ü–∞ / –ò–Ω–¥–µ–∫—Å         | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                                 |
| --------------------------- | ------------------------ | ------------------------------------------------------------------------------------------ |
| **PostgreSQL (AuthDB)**     | `users`                  | –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Å–≤—è–∑—å —Å —Å–µ—Å—Å–∏—è–º–∏                                       |
|                             | `subscriptions`          | –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π                                                           |
|                             | `moderators`             | –†–æ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø—ã –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤                                                                 |
| **PostgreSQL (VideoDB)**    | `videos`                 | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, ID –≤–ª–∞–¥–µ–ª—å—Ü–∞, –¥–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏, —Ñ–ª–∞–≥–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏)        |
|                             | `video_stats`            | –°—á—ë—Ç—á–∏–∫–∏ –ª–∞–π–∫–æ–≤, –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ –≤–∏–¥–µ–æ (–¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)              |
|                             | `video_storage_metadata` | –°–ª—É–∂–µ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –≤ MinIO: –ø—É—Ç—å, –≤–µ—Ä—Å–∏—è, —Ñ–æ—Ä–º–∞—Ç, thumbnail                |
| **ClickHouse (ActivityDB)** | `views`                  | –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (user_id, video_id, timestamp)                                |
|                             | `likes`                  | –°–æ–±—ã—Ç–∏—è –ª–∞–π–∫–æ–≤ —Å —Ç–æ—á–Ω—ã–º–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏                                                |
|                             | `comments`               | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –∏–µ—Ä–∞—Ä—Ö–∏—è –æ—Ç–≤–µ—Ç–æ–≤                                                             |
|                             | `reports`                | –†–µ–ø–æ—Ä—Ç—ã –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π                                                       |
| **Redis**                   | `sessions`               | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã / refresh-—Ç–æ–∫–µ–Ω—ã / CSRF-–∑–∞—â–∏—Ç–∞ / TTL                                |
| **MinIO (S3 —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ)**  | `video_files`            | –§–∞–π–ª—ã –≤–∏–¥–µ–æ, –ø—Ä–µ–≤—å—é, thumbnails ‚Äî —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ UUID                                         |
| **Elasticsearch**           | `video_search_index`     | –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å: –Ω–∞–∑–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏—è, —Ç–µ–≥–∏, –∏–º–µ–Ω–∞ –∞–≤—Ç–æ—Ä–æ–≤ (–¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π) |


## –ò–Ω–¥–µ–∫—Å—ã

### PostgreSQL
| –¢–∞–±–ª–∏—Ü–∞         | –ò–Ω–¥–µ–∫—Å                              | –¢–∏–ø   |
| --------------- | ----------------------------------- | ----- |
| `users`         | `email`, `username`                 | BTREE |
| `videos`        | `upload_date`                       | BTREE |
| `video_stats`   | `video_id`                          | BTREE |
| `subscriptions` | `(subscriber_id, subscribed_to_id)` | BTREE |


### Clickhouse
| –¢–∞–±–ª–∏—Ü–∞    | PRIMARY KEY              | ORDER BY                 |
| ---------- | ------------------------ | ------------------------ |
| `views`    | `(video_id, user_id)`    | `(video_id, view_date)`  |
| `likes`    | `(video_id, user_id)`    | `(video_id, created_at)` |
| `comments` | `(video_id, created_at)` | `(video_id, created_at)` |
| `reports`  | `(video_id, created_at)` | `(video_id, created_at)` |

### Elasticsearch
| –ò–Ω–¥–µ–∫—Å               | –ü–æ–ª—è                                          | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                          |
| -------------------- | --------------------------------------------- | ----------------------------------- |
| `video_search_index` | `title`, `description`, `tags`, `author_name` | –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ |


## –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
| –¢–∞–±–ª–∏—Ü–∞                  | –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è                         | –ü—Ä–∏—á–∏–Ω–∞                                  |
| ------------------------ | ---------------------------------------------- | ---------------------------------------- |
| `video_stats`            | `total_views`, `total_likes`                   | –ë—ã—Å—Ç—Ä—ã–µ –≤—ã–±–æ—Ä–∫–∏ –±–µ–∑ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏            |
| `views` / `likes`        | `video_id`, `user_id`                          | –£–ø—Ä–æ—â–µ–Ω–∏–µ JOIN-–æ–≤ –≤ ClickHouse           |
| `comments`               | `parent_comment_id`                            | –ë—ã—Å—Ç—Ä–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤            |
| `video_storage_metadata` | `bucket`, `object_key`, `resolution`, `format` | –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º –±–µ–∑ JOIN —Å MinIO |


## –í—ã–±–æ—Ä –ë–î

| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                    | –°–£–ë–î              | –ü—Ä–∏—á–∏–Ω–∞ –≤—ã–±–æ—Ä–∞                     |
| ----------------------------- | ----------------- | ---------------------------------- |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ      | **PostgreSQL**    | ACID, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏                   |
| –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã, –ª–∞–π–∫–∏) | **ClickHouse**    | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ real-time              |
| –í–∏–¥–µ–æ-—Ñ–∞–π–ª—ã                   | **MinIO (S3)**    | –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–µ –æ–±—ä–µ–∫—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ |
| –°–µ—Å—Å–∏–∏ / –∫–µ—à                  | **Redis Cluster** | In-memory, TTL                     |
| –ü–æ–∏—Å–∫                         | **Elasticsearch** | –ë—ã—Å—Ç—Ä—ã–π –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫       |


## –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                 | –ú–µ—Ç–æ–¥ —à–∞—Ä–¥–∏–Ω–≥–∞                     | –†–µ–ø–ª–∏–∫–∞—Ü–∏—è / —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ   |
| ------------------------- | ---------------------------------- | ----------------------------- |
| PostgreSQL (Auth / Video) | Hash –ø–æ `user_id` –∏–ª–∏ `video_id`   | Master + 2 replicas (async)   |
| ClickHouse                | Distributed table –ø–æ `video_id`    | ReplicatedMergeTree (2 –∫–æ–ø–∏–∏) |
| Redis                     | –ê –æ–Ω —Ç—É—Ç –Ω—É–∂–µ–Ω?                    | Cluster mode + Sentinel       |
| MinIO                     | Erasure coding + replication       | 4‚Äì8 –Ω–æ–¥, 2 parity –±–ª–æ–∫–∞       |
| Elasticsearch             | Shards –ø–æ `video_id` + replica     | primary + replica shards      |


## –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç         | –ö–ª–∏–µ–Ω—Ç (Go)                   | –ó–∞–º–µ—Ç–∫–∏                  |
| ----------------- | ----------------------------- | ------------------------ |
| PostgreSQL        | `pgx`                         | connection pooling       |
| ClickHouse        | `clickhouse-go/v2`            | async –≤—Å—Ç–∞–≤–∫–∞ –±–∞—Ç—á–∞–º–∏    |
| Redis             | `go-redis/v9`                 | –¥–ª—è —Å–µ—Å—Å–∏–π –∏ –∫–µ—à–∞        |
| MinIO             | `minio-go/v7`                 | multipart upload         |
| Elastic           | `elastic/go-elasticsearch/v8` | –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –≤–Ω–µ—à–Ω–∏–π –ø–æ–∏—Å–∫ |

## –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç           | –ú–µ—Ç–æ–¥                | –ß–∞—Å—Ç–æ—Ç–∞                | –•—Ä–∞–Ω–µ–Ω–∏–µ           |
| ------------------- | -------------------- | ---------------------- | ------------------ |
| PostgreSQL          | `pg_dump` + WAL      | –∫–∞–∂–¥—ã–µ 6 —á (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç) | S3 / MinIO         |
| ClickHouse          | `BACKUP TABLE` ‚Üí S3  | 1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏          | S3 snapshot        |
| MinIO               | Snapshot replication | —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏            | –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä  |
| –ö–æ–Ω—Ñ–∏–≥–∏ (YAML, env) | Git + S3 backup      | –ø—Ä–∏ –¥–µ–ø–ª–æ–µ             | Git / S3           |

## –ê–ª–≥–æ—Ä–∏—Ç–º—ã 
### 7.1. –ê–ª–≥–æ—Ä–∏—Ç–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ (HLS/DASH)

**–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:** –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ **–ø–ª–∞–≤–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞** –ø—Ä–∏ —Ä–∞–∑–ª–∏—á–Ω–æ–º –∫–∞—á–µ—Å—Ç–≤–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

* **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:** –í–∏–¥–µ–æ –∑–∞—Ä–∞–Ω–µ–µ –∫–æ–¥–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤ (1080p, 720p –∏ —Ç.–¥.). –ö–∞–∂–¥–∞—è –≤–µ—Ä—Å–∏—è –Ω–∞—Ä–µ–∑–∞–µ—Ç—Å—è –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ **—á–∞–Ω–∫–∏** (2-10 —Å–µ–∫—É–Ω–¥). –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è **–º–∞–Ω–∏—Ñ–µ—Å—Ç-—Ñ–∞–π–ª**.
* **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:** –ü–ª–µ–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–æ —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞. –û—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è —Å–∫–æ—Ä–æ—Å—Ç—å —Å–µ—Ç–∏.
* **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è:** –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞–Ω–∫–æ–≤, —É—Ä–æ–≤–µ–Ω—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞ –∏ —á–∞—Å—Ç–æ—Ç—É –ø–æ—Ç–µ—Ä—å –ø–∞–∫–µ—Ç–æ–≤. –ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –º–µ—Ç—Ä–∏–∫ **–≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ** –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞–Ω–∫–∞.
    * –ü—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ —Å–≤—è–∑–∏ -> –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –±–æ–ª–µ–µ **–Ω–∏–∑–∫–æ–µ** –∫–∞—á–µ—Å—Ç–≤–æ (Graceful Degradation).
    * –ü—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ -> –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ **–ø–æ–≤—ã—à–µ–Ω–∏–µ** –∫–∞—á–µ—Å—Ç–≤–∞.

---

### 7.2. –ê–ª–≥–æ—Ä–∏—Ç–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ–∫–æ–Ω—Ç–µ–Ω—Ç–∞

**–ü–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

1.  **–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ** -> Upload Service –∫–ª–∞–¥–µ—Ç –≤–∏–¥–µ–æ –≤ MinIO –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ Kafka Upload
2.  **–û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏** -> Video Service –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ, —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É –≤ Kafka Video
3.  **–í–æ—Ä–∫–µ—Ä—ã –∞–Ω–∞–ª–∏–∑–∞** ->
    * –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ: **YOLOv8** (–æ–±—ä–µ–∫—Ç—ã), **CLIP** (—Å—Ü–µ–Ω—ã), **OCR** (—Ç–µ–∫—Å—Ç)
    * –ê—É–¥–∏–æ–∞–Ω–∞–ª–∏–∑: **Whisper** (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)
    * –¢–µ–∫—Å—Ç: **BERT** (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏, —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏), **CatBoost** (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
4.  **–û–±–æ–≥–∞—â–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö** -> —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∏—à—É—Ç—Å—è –≤ PostgreSQL `videos` —á–µ—Ä–µ–∑ Kafka
5.  **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞** -> Search Index Worker –æ–±–Ω–æ–≤–ª—è–µ—Ç Elasticsearch

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.

---

### 7.3. –ê–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

**–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

#### Level 1 - –ö–∞–Ω–¥–∏–¥–∞—Ç—ã:
–°–±–æ—Ä –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–∏–¥–µ–æ.

* API Service -> Recommendation Service -> Single Rec Engine
* **–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:**
    * **Content-based:** –ø–æ—Ö–æ–∂–∏–µ –≤–∏–¥–µ–æ (Item Features DB)
    * **Collaborative:** –ø–æ—Ö–æ–∂–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (Users History DB)
    * **Trending:** –ø–æ–ø—É–ª—è—Ä–Ω–æ–µ (Redis `rec_cache`)
    * **Fresh:** –Ω–æ–≤–æ–µ (PostgreSQL `videos`)

#### Level 2 - –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ:
–£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏.

* Single Rec Engine -> **ML Ranking Module**
* **–ú–æ–¥–µ–ª–∏:** Two-Tower (—Å–µ–º–∞–Ω—Ç–∏–∫–∞), DeepFM (–ø—Ä–∏–∑–Ω–∞–∫–∏), ALS (–∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—è)
* **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –∏—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—Ä–µ–º—è, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

**–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π:**
* User Activity Worker -> Users History DB
* Train Ranker Worker –æ–±—É—á–∞–µ—Ç –º–æ–¥–µ–ª–∏ -> Ranking Models DB

---

### 7.4. –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ üîé

**–ü–æ–∏—Å–∫–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω:**

#### –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è:
1.  Video Service/Upload Service -> Kafka -> Search Index Worker
2.  **–î–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞:** –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ), –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏, –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã —Ä–µ—á–∏ (Whisper), –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (CLIP).
3.  **–ò–Ω–¥–µ–∫—Å:** Elasticsearch + PostgreSQL `search_index`

#### –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:
1.  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -> L7 search -> Search Service
2.  Request Filler –æ–±–æ–≥–∞—â–∞–µ—Ç –∑–∞–ø—Ä–æ—Å (–∏—Å—Ç–æ—Ä–∏—è –∏–∑ Redis)
3.  Search App –∏—â–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (Elasticsearch + PostgreSQL)
4.  **ML Ranking Module** —Ä–∞–Ω–∂–∏—Ä—É–µ—Ç (–º–æ–¥–µ–ª–∏ –∏–∑ Ranking Models DB)

**–ú–æ–¥–µ–ª–∏ –ø–æ–∏—Å–∫–∞:**
* –¢–µ–∫—Å—Ç: **BM25** + **Sentence-BERT**
* –í–∏–∑—É–∞–ª: **CLIP** —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
* –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ: **LambdaMART**

---

### 7.5. –ê–ª–≥–æ—Ä–∏—Ç–º —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ üì¶

**–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö –≤–∏–¥–µ–æ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤ –∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—é –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–º—É —Å—Ç—Ä–∏–º–∏–Ω–≥—É.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

* **–ü—Ä–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å, –ø–æ–º–µ—â–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å.
* **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
    * **–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ multiple bitrate** (—Å–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π —Ä–∞–∑–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞).
    * **–ö–æ–Ω—Ç–µ–Ω—Ç-–∞–Ω–∞–ª–∏–∑** (–∑–∞–ø—É—Å–∫ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ 7.2).
* **–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —á–∞–Ω–∫–∏:** –ù–∞—Ä–µ–∑–∫–∞ –∫–∞–∂–¥–æ–π –≤–µ—Ä—Å–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã (2-10 —Å–µ–∫—É–Ω–¥) –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤/–º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤.
* **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:** –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–Ω—Ç–µ–Ω—Ç-–∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î, –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–∏—Å–∫–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã. –í–∏–¥–µ–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º.

# 8 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ |
|------------|-------------------|-------------------|
| **Go (Golang)** | –ë—ç–∫–µ–Ω–¥-—Å–µ—Ä–≤–∏—Å—ã, API | –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ |
| **Nginx** | –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ (L7), —Ä–∞–∑–¥–∞—á–∞ —Å—Ç–∞—Ç–∏–∫–∏ | –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≥–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å |
| **Docker, Kubernetes** | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è | –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å, —É–ø—Ä–æ—â–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è |
| **Apache Kafka** | –û—á–µ—Ä–µ–¥–∏ —Å–æ–±—ã—Ç–∏–π, —Å—Ç—Ä–∏–º–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö | –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π |
| **Grafana + Prometheus** | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –≥–∏–±–∫–∏–µ –¥–∞—à–±–æ—Ä–¥—ã, –æ–ø–æ–≤–µ—â–µ–Ω–∏—è |
| **HAProxy** | –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ (L4) | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ TCP-—Ç—Ä–∞—Ñ–∏–∫–∞, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ |
| **FFmpeg** | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ | –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ |
| **hls.js** | –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–ª–µ–µ—Ä (–±—Ä–∞—É–∑–µ—Ä) | –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HLS/DASH |
| **Jaeger** | –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–π—Å–∏–Ω–≥ | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º |  
| **ArgoCD** | GitOps –¥–µ–ø–ª–æ–π | –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–µ–ø–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º |

# 10 –°—Ö–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–∞
```mermaid
---
config:
  layout: dagre
---
flowchart TB
 subgraph L7["L7: –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ö–æ—Å—Ç—ã"]
    direction LR
        L7_AUTH["l7: auth"]
        L7_EDGE["L7 Ingress / API Gateway<br>Traefik / Kong<br>(Rate Limiting, Retries)"]
        L7_API["l7: api"]
        L7_REC["l7: rec"]
        L7_SEARCH["l7: search"]
        L7_VIDEO["l7: video"]
        L7_UPLOAD["l7: upload"]
  end
 subgraph CORE["Backend Services (Stateless K8s Pods)"]
    direction TB
        AUTH_SERVICE["Auth Service<br>Go"]
        API_SERVICE["API Service<br>Go"]
        VIDEO_SERVICE["Video Service<br>Go"]
        UPLOAD_SERVICE["Upload Service<br>Go"]
        REC_SERVICE["Recommendation Service<br><br>"]
        SEARCH_SERVICE["Search Service<br>(Fallback logic)"]
  end
 subgraph KAFKA_CLUSTER["Kafka Cluster (HA 3+ brokers)"]
    direction LR
        KAFKA_AUTH[["kafka: auth"]]
        KAFKA_API[["kafka: api"]]
        KAFKA_UPLOAD[["kafka: upload"]]
        KAFKA_EVENTS[["kafka: events"]]
        DLQ_UPLOAD[["DLQ: upload.errors"]]
        DLQ_API[["DLQ: api.errors"]]
  end
 subgraph WORKERS["Workers (Auto-scaling)"]
    direction TB
        UPLOAD_WORKER["Upload Worker"]
        ITEM_FEATURES_WORKER["Item Features Worker"]
        USER_ACTIVITY_WORKER["User Activity Worker"]
        RECENT_SEARCH_WORKER["Recent Search Worker"]
        TRAFFIC_MARKER_WORKER["Traffic Marker Worker"]
        SEARCH_INDEX_WORKER["Search Index Worker"]
        TRAIN_RANKER_WORKER["Train Ranker Worker"]
        SIMPLE_RANKER["Simple Ranker"]
  end
 subgraph STORAGE["–•—Ä–∞–Ω–∏–ª–∏—â–∞ (Primary + Replicas)"]
    direction LR
        MINIO[("MinIO Cluster<br>(Erasure Coding)")]
        PG_VIDEO[("PG: Video<br>(Master + Read Replicas)")]
        PG_AUTH[("PG: Users<br>(Master + Standby)")]
        ITEM_FEATURES_DB[("PG: Features")]
        RANKING_MODELS_DB[("PG: Models")]
        REDIS_SESS[("Redis Cluster<br>Sessions")]
        REDIS_REC[("Redis Cluster<br>Top/Popular Cache")]
        ES[("Elasticsearch Cluster<br>Search Index")]
        DWH_DB[("ClickHouse Shards")]
  end
    EXT_USER["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"] --> ANYCAST["Anycast IP<br>–ë–ª–∏–∂–∞–π—à–∏–π –î–¶"]
    ANYCAST --> L4_EXT["L4 –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫<br>HAProxy (Active/Passive)"]
    L4_EXT --> L7_EDGE
    L7_EDGE --> L7_AUTH & L7_API & L7_REC & L7_SEARCH & L7_VIDEO & L7_UPLOAD
    L7_AUTH --> AUTH_SERVICE
    L7_API --> API_SERVICE
    L7_VIDEO --> VIDEO_SERVICE
    L7_UPLOAD --> UPLOAD_SERVICE
    L7_REC --> REC_SERVICE
    L7_SEARCH --> SEARCH_SERVICE
    AUTH_SERVICE --> REDIS_SESS & KAFKA_AUTH
    API_SERVICE --> REDIS_SESS & PG_VIDEO
    API_SERVICE -- Async events --> KAFKA_API
    UPLOAD_SERVICE --> KAFKA_UPLOAD
    KAFKA_UPLOAD --> UPLOAD_WORKER
    UPLOAD_WORKER -- Error limit exceeded --> DLQ_UPLOAD
    UPLOAD_WORKER --> MINIO & PG_VIDEO & KAFKA_EVENTS
    VIDEO_SERVICE --> MINIO & API_SERVICE
    API_SERVICE -- CDN URL --> CDN["CDN"]
    SEARCH_SERVICE --> ES & SEARCH_INDEX_WORKER & REQUEST_FILLER["Request Filler"]
    ES --> SEARCH_SERVICE
    SEARCH_INDEX_WORKER --> ES
    REQUEST_FILLER --> RECENT_SEARCHES_DB["Redis: recent"]
    SEARCH_SERVICE -. [Fallback] ES Down/Slow:<br>Search in DB (Slow but works) .-> PG_VIDEO
    SEARCH_SERVICE -. [Fallback] Empty/Error:<br>Return Recent/Trending .-> RECENT_SEARCHES_DB
    REC_SERVICE --> REC_ENGINE_SINGLE["Candidate Generator"] & API_SERVICE
    REC_ENGINE_SINGLE --> ITEM_FEATURES_DB & REDIS_REC
    REC_SERVICE -. </br> .-> REDIS_REC
    REDIS_REC --> SIMPLE_RANKER
    SIMPLE_RANKER --> REC_SERVICE
    KAFKA_API --> ITEM_FEATURES_WORKER & USER_ACTIVITY_WORKER
    USER_ACTIVITY_WORKER -- On Error --> DLQ_API
    KAFKA_EVENTS --> EVENTS_SERVICE["Events Service"]
    EVENTS_SERVICE --> DWH_DB
    ITEM_FEATURES_WORKER --> ITEM_FEATURES_DB
    USER_ACTIVITY_WORKER --> PG_VIDEO
    RECENT_SEARCH_WORKER --> RECENT_SEARCHES_DB
    TRAIN_RANKER_WORKER --> RANKING_MODELS_DB
    TRAFFIC_MARKER_WORKER --> RANKING_MODELS_DB
    PG_VIDEO -. Read Replicas .-> API_SERVICE & SEARCH_SERVICE
    PROMETHEUS["Prometheus"] -.-> CORE & WORKERS
    PROMETHEUS --> GRAFANA["Grafana"]
    KAFKA_AUTH --- KAFKA_CLUSTER
    KAFKA_API --- KAFKA_CLUSTER
    KAFKA_UPLOAD --- KAFKA_CLUSTER

     DLQ_UPLOAD:::dlq
     DLQ_API:::dlq
     MINIO:::storage
     PG_VIDEO:::storage
     PG_AUTH:::storage
     REDIS_SESS:::storage
     REDIS_REC:::storage
     ES:::storage
     DWH_DB:::storage
    classDef storage fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef fallback stroke:#d32f2f,stroke-width:2px,stroke-dasharray: 5 5,color:#d32f2f
    classDef dlq fill:#ffcdd2,stroke:#b71c1c
```

# 11

## RPS –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º

| –°–µ—Ä–≤–∏—Å | –°—Ä–µ–¥–Ω–∏–π RPS | –ü–∏–∫–æ–≤—ã–π RPS |
|--------|-------------|-------------|
| Auth Service | 1,155 | 3,465 |
| Video Service | 2,117 | 6,351 |
| API Service | 2,315 | 6,945 |
| Recommendation Service | 2,315 | 6,945 |
| Search Service | 231 | 693 |
| Upload Service | 4.3 | 13 |
| –ò—Ç–æ–≥–æ | 8,137 | 24,412 |

## –†–µ—Å—É—Ä—Å—ã –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ (Go)

| –°–µ—Ä–≤–∏—Å | CPU (cores) | RAM (GB) | Replicas |
|--------|-------------|----------|----------|
| Auth Service | 6.9 | 13.8 | 7 |
| Video Service | 12.7 | 25.4 | 13 |
| API Service | 13.9 | 27.8 | 14 |
| Recommendation Service | 13.9 | 27.8 | 14 |
| Search Service | 1.4 | 2.8 | 2 |
| Upload Service | 0.03 | 0.06 | 1 |
| –ò—Ç–æ–≥–æ | 48.8 | 97.7 | 51 |

## –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### PostgreSQL
- –ù–∞–≥—Ä—É–∑–∫–∞: 30,000 QPS
- –°–µ—Ä–≤–µ—Ä–æ–≤: 12
- CPU: 180 —è–¥–µ—Ä (15 —è–¥–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
- RAM: 3 –¢–ë (256 –ì–ë –Ω–∞ —Å–µ—Ä–≤–µ—Ä)

### Redis
- –ù–∞–≥—Ä—É–∑–∫–∞: 300,000 QPS  
- –°–µ—Ä–≤–µ—Ä–æ–≤: 8
- CPU: 16 —è–¥–µ—Ä (2 —è–¥—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
- RAM: 256 –ì–ë (32 –ì–ë –Ω–∞ —Å–µ—Ä–≤–µ—Ä)

### ClickHouse
- –ù–∞–≥—Ä—É–∑–∫–∞: 3,000 QPS
- –°–µ—Ä–≤–µ—Ä–æ–≤: 4
- CPU: 32 —è–¥–µ—Ä (8 —è–¥–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
- RAM: 256 –ì–ë (64 –ì–ë –Ω–∞ —Å–µ—Ä–≤–µ—Ä)

### Elasticsearch
- –ù–∞–≥—Ä—É–∑–∫–∞: 693 RPS
- –°–µ—Ä–≤–µ—Ä–æ–≤: 6
- CPU: 48 —è–¥–µ—Ä (8 —è–¥–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
- RAM: 192 –ì–ë (32 –ì–ë –Ω–∞ —Å–µ—Ä–≤–µ—Ä)

## –û—á–µ—Ä–µ–¥–∏ –∏ –≤–æ—Ä–∫–µ—Ä—ã

### Kafka
- –ë—Ä–æ–∫–µ—Ä–æ–≤: 8 —Å–µ—Ä–≤–µ—Ä–æ–≤
- –ù–∞–≥—Ä—É–∑–∫–∞: 10,000 RPS
- CPU: 48 —è–¥–µ—Ä (6 —è–¥–µ—Ä –Ω–∞ –±—Ä–æ–∫–µ—Ä)
- RAM: 256 –ì–ë (32 –ì–ë –Ω–∞ –±—Ä–æ–∫–µ—Ä)

### Workers
| Worker | –ù–∞–≥—Ä—É–∑–∫–∞ | CPU | RAM | Replicas |
|--------|----------|-----|-----|----------|
| Item Features Worker | 3,000 RPS | 15 | 30 GB | 6 |
| User Activity Worker | 4,500 RPS | 22.5 | 45 GB | 9 |
| Recent Search Worker | 346 RPS | 1.7 | 3.5 GB | 2 |
| Traffic Marker Worker | 1,500 RPS | 7.5 | 15 GB | 3 |
| Search Index Worker | 750 RPS | 3.8 | 7.5 GB | 2 |
| Train Ranker Worker | 300 RPS | 3 | 12 GB | 1 |
| –ò—Ç–æ–≥–æ | 10,396 RPS | 53.5 | 113 GB | 23 |

## –•—Ä–∞–Ω–∏–ª–∏—â–µ (MinIO)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –°–µ—Ä–≤–µ—Ä–æ–≤ | 48 |
| –¢–µ–∫—É—â–∏–π –æ–±—ä—ë–º | 2,234 –ü–ë |
| –ß—Ç–µ–Ω–∏–µ QPS | 1.43 –º–ª–Ω |
| CPU | 286 —è–¥–µ—Ä (6 —è–¥–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä) |
| RAM | 1.5 –¢–ë (32 –ì–ë –Ω–∞ —Å–µ—Ä–≤–µ—Ä) |

## GPU –∫–ª–∞—Å—Ç–µ—Ä

| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | GPU –¢–∏–ø | –°–µ—Ä–≤–µ—Ä—ã | CPU | RAM | VRAM |
|------------|---------|---------|-----|-----|------|
| –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è | A100 80GB | 6 | 96 —è–¥–µ—Ä | 768 –ì–ë | 960 –ì–ë |
| –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ | RTX 4090 | 4 | 64 —è–¥–µ—Ä | 512 –ì–ë | 192 –ì–ë |
| –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ | A100 40GB | 3 | 48 —è–¥–µ—Ä | 384 –ì–ë | 240 –ì–ë |
| –ò—Ç–æ–≥–æ | | 13 | 208 —è–¥–µ—Ä | 1.66 –¢–ë | 1.392 –¢–ë |

## –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°–µ—Ä–≤–µ—Ä—ã | –í—Å–µ–≥–æ CPU | –í—Å–µ–≥–æ RAM |
|-----------|---------|-----------|-----------|
| Kubenodes | 18 | 576 —è–¥–µ—Ä | 2.3 –¢–ë |
| PostgreSQL | 12 | 180 —è–¥–µ—Ä | 3 –¢–ë |
| Redis | 8 | 16 —è–¥–µ—Ä | 256 –ì–ë |
| Kafka | 8 | 48 —è–¥–µ—Ä | 256 –ì–ë |
| ClickHouse | 4 | 32 —è–¥–µ—Ä | 256 –ì–ë |
| Elasticsearch | 6 | 48 —è–¥–µ—Ä | 192 –ì–ë |
| MinIO | 48 | 288 —è–¥–µ—Ä | 1.5 –¢–ë |
| GPU —Å–µ—Ä–≤–µ—Ä—ã | 13 | 208 —è–¥–µ—Ä | 1.66 –¢–ë |
| –í—Å–µ–≥–æ | 117 | 1,396 —è–¥–µ—Ä | ~9.2 –¢–ë |

## –°—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–æ–∏–º–æ—Å—Ç—å/–º–µ—Å |
|-----------|---------------|
| Kubenodes (18 √ó $800) | $14,400 |
| –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (30 √ó $600) | $18,000 |
| Kafka (8 √ó $500) | $4,000 |
| MinIO (48 √ó $400) | $19,200 |
| GPU (13 √ó $2,400) | $31,200 |
| CDN/–°–µ—Ç—å | $10,000 |
| –ò—Ç–æ–≥–æ | $96,800/–º–µ—Å—è—Ü |


[1]: https://tass.ru/ekonomika/24311321 "–ò—Å—Ç–æ—á–Ω–∏–∫"
[2]: https://inclient.ru/rutube-stats/#rutube3 "–ù–µ —É–≤–µ—Ä–µ–Ω –≤–µ—Ä–∏—Ç—å –ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫—É"
[3]: https://www.similarweb.com/ru/website/rutube.ru/#demographics "–¢—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º"
[5]: https://www.cnews.ru/news/line/2025-09-04_dnevnaya_auditoriya_rutube_vyrosla "–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä—É—Ç—É–±—É"
[6]: https://affmaven.com/ru/youtube-statistics/ "–¢–∞–±–ª–∏—á–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä—É—Ç—É–±–∞ –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–µ–º —Å–ø—Ä–æ–µ—Ü–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä—É—Ç—É–±"
[7]: https://habr.com/ru/news/896842/ "388–∫–∫ –≤–∏–¥–µ–æ –Ω–∞ —Ä—É—Ç—É–±–µ"
[8]: ... "–ò—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–µ—Ç, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–∫–∏"
[9]: https://skillbox.ru/media/marketing/mediascope-opublikovala-issledovanie-auditorii-sotsialnykh-media-youtube-poka-eshchye-lider/ "–ò–Ω—Ñ–∞ –æ—Ç –º–µ–¥–∏–∞—Å–∫–æ—É–ø–∞"
[10]: https://habr.com/ru/news/926262/
